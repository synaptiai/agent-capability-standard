schema:
  name: canonical_world_state
  version: 1.0.0
  description: Canonical, composition-safe world-state representation for real+digital
    modeling. Designed for agent workflows (evidence, uncertainty, provenance, transitions).
  generated_at: '2026-01-24T02:33:26.585814Z'
  principles:
  - Everything is time-indexed.
  - Every claim is grounded in evidence anchors.
  - Uncertainty is explicit (epistemic vs aleatoric).
  - Identity is stable and aliasable.
  - State is separate from observations and from predictions.
  - Transitions are first-class, reversible where possible.
types:
  Anchor:
    type: object
    required:
    - ref
    - kind
    properties:
      ref:
        type: string
        description: Pointer like file:line, URL, tool-output-id
      kind:
        type: string
        enum:
        - file
        - url
        - tool
        - log
        - sensor
        - human_note
      excerpt:
        type: string
      timestamp:
        type: string
        description: ISO-8601 Z
        nullable: true
  Uncertainty:
    type: object
    required:
    - type
    - confidence
    properties:
      type:
        type: string
        enum:
        - epistemic
        - aleatoric
        - mixed
      confidence:
        type: number
        minimum: 0
        maximum: 1
      interval:
        type: object
        properties:
          low:
            type: number
          high:
            type: number
        nullable: true
      distribution:
        type: object
        nullable: true
        description: 'e.g. {name: normal, mean: x, stdev: y}'
      notes:
        type: string
        nullable: true
  Quantity:
    type: object
    required:
    - value
    properties:
      value:
        type:
        - number
        - string
        - boolean
        - object
      unit:
        type: string
        nullable: true
      scale:
        type: string
        nullable: true
        description: e.g. ordinal, nominal
      uncertainty:
        $ref: '#/types/Uncertainty'
        nullable: true
  EntityRef:
    type: object
    required:
    - entity_id
    properties:
      entity_id:
        type: string
      entity_type:
        type: string
        nullable: true
      alias:
        type: string
        nullable: true
  ProvenanceRecord:
    type: object
    required:
    - claim_id
    - created_at
    - agent
    - capability
    - anchors
    properties:
      claim_id:
        type: string
      created_at:
        type: string
      agent:
        type: string
        description: subagent/skill name
      capability:
        type: string
        description: capability id
      anchors:
        type: array
        items:
          $ref: '#/types/Anchor'
      transformations:
        type: array
        items:
          type: string
        nullable: true
      assumptions:
        type: array
        items:
          type: string
        nullable: true
  RelationshipEdge:
    type: object
    required:
    - src
    - dst
    - relation
    properties:
      src:
        $ref: '#/types/EntityRef'
      dst:
        $ref: '#/types/EntityRef'
      relation:
        type: string
        description: edge type, e.g. depends_on, owns, located_in
      attributes:
        type: object
        nullable: true
      constraints:
        type: object
        nullable: true
      uncertainty:
        $ref: '#/types/Uncertainty'
        nullable: true
      provenance:
        type: array
        items:
          $ref: '#/types/ProvenanceRecord'
        nullable: true
  StateVariable:
    type: object
    required:
    - name
    - subject
    - value
    - timestamp
    - source
    properties:
      name:
        type: string
      subject:
        $ref: '#/types/EntityRef'
      value:
        $ref: '#/types/Quantity'
      timestamp:
        type: string
        description: ISO-8601
      source:
        type: string
        enum:
        - observation
        - inference
        - prediction
        - assumption
        - constraint
      valid_for:
        type: string
        nullable: true
        description: duration window e.g. PT5M
      provenance:
        type: array
        items:
          $ref: '#/types/ProvenanceRecord'
      tags:
        type: array
        items:
          type: string
        nullable: true
  ObservationEvent:
    type: object
    required:
    - event_id
    - timestamp
    - source
    - payload
    - anchors
    properties:
      event_id:
        type: string
      timestamp:
        type: string
      source:
        type: string
        description: sensor/log/api/human
      payload:
        type: object
      anchors:
        type: array
        items:
          $ref: '#/types/Anchor'
      parsed_as:
        type: array
        items:
          type: string
        nullable: true
        description: event types
      uncertainty:
        $ref: '#/types/Uncertainty'
        nullable: true
  TransitionRule:
    type: object
    required:
    - rule_id
    - trigger
    - guards
    - effects
    - allowed_next_states
    properties:
      rule_id:
        type: string
      trigger:
        type: object
        description: event predicate / schedule predicate
      guards:
        type: array
        items:
          type: string
      effects:
        type: array
        items:
          type: string
          description: state variable updates
      allowed_next_states:
        type: array
        items:
          type: string
      rollback:
        type: object
        nullable: true
        properties:
          strategy:
            type: string
          inverse_effects:
            type: array
            items:
              type: string
      provenance:
        type: array
        items:
          $ref: '#/types/ProvenanceRecord'
        nullable: true
  ActionRecord:
    type: object
    required:
    - action_id
    - timestamp
    - actor
    - intent
    - status
    properties:
      action_id:
        type: string
      timestamp:
        type: string
      actor:
        type: string
        description: agent/human
      intent:
        type: string
      status:
        type: string
        enum:
        - planned
        - approved
        - executed
        - failed
        - rolled_back
      plan_ref:
        type: string
        nullable: true
      changes:
        type: array
        items:
          type: string
        nullable: true
      verification:
        type: array
        items:
          type: string
        nullable: true
      anchors:
        type: array
        items:
          $ref: '#/types/Anchor'
        nullable: true
world_state:
  type: object
  required:
  - meta
  - entities
  - relationships
  - state_variables
  - observations
  - transition_rules
  - actions
  - indexes
  properties:
    meta:
      type: object
      required:
      - world_id
      - as_of
      - timezone
      properties:
        world_id:
          type: string
          description: namespace like project/system id
        as_of:
          type: string
          description: ISO-8601 snapshot time
        timezone:
          type: string
          description: IANA tz
        scope:
          type: string
          nullable: true
        owner:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        version_id:
          type: string
          description: Unique snapshot version (e.g., sha256 of canonical content).
        parent_version_id:
          type: string
          nullable: true
          description: Previous snapshot this derives from.
        lineage:
          type: array
          items:
            type: string
          description: Ordered list of ancestor version_ids.
          nullable: true
    entities:
      type: array
      items:
        type: object
        required:
        - id
        - type
        - labels
        - aliases
        - attributes
        - status
        - provenance
        properties:
          id:
            type: string
          type:
            type: string
            description: entity class, e.g. service, host, person, document
          labels:
            type: array
            items:
              type: string
          aliases:
            type: array
            items:
              type: string
          attributes:
            type: object
          status:
            type: string
            nullable: true
          provenance:
            type: array
            items:
              $ref: '#/types/ProvenanceRecord'
          uncertainty:
            $ref: '#/types/Uncertainty'
            nullable: true
    relationships:
      type: array
      items:
        $ref: '#/types/RelationshipEdge'
    state_variables:
      type: array
      items:
        $ref: '#/types/StateVariable'
    observations:
      type: array
      items:
        $ref: '#/types/ObservationEvent'
    transition_rules:
      type: array
      items:
        $ref: '#/types/TransitionRule'
    actions:
      type: array
      items:
        $ref: '#/types/ActionRecord'
    indexes:
      type: object
      required:
      - by_entity
      - by_variable
      - by_time
      properties:
        by_entity:
          type: object
          description: entity_id -> pointers
        by_variable:
          type: object
          description: variable_name -> pointers
        by_time:
          type: object
          description: time buckets -> pointers
    retention_policy:
      type: object
      required:
      - observations
      - audit_logs
      - snapshots
      properties:
        observations:
          type: object
          properties:
            max_age:
              type: string
              description: ISO-8601 duration e.g. P30D
            max_count:
              type: integer
        audit_logs:
          type: object
          properties:
            max_age:
              type: string
              description: ISO-8601 duration e.g. P90D
        snapshots:
          type: object
          properties:
            max_count:
              type: integer
            keep_tagged:
              type: boolean
composition_contracts:
  world_state_out:
    description: Canonical output object for the `/world-state` capability.
    fields:
    - meta
    - entities
    - relationships
    - state_variables
    - observations
    - transition_rules
    - actions
    - indexes
    guarantees:
    - All entities have stable ids and provenance.
    - All state variables are time-indexed and carry uncertainty.
    - All relationships carry optional uncertainty and provenance.
    - Observations are append-only and grounded.
    - Transition rules are explicit and reversible when possible.
